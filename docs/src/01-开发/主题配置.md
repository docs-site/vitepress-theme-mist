---
title: 主题配置
date: 2025-08-17 11:49:33
icon: famicons:logo-markdown
index: true
tags:
categories:
copyright: true
keywords:
cover:
comments:
mathjax:
top:
description:
---

vitepress的配置合并。

<!-- more -->

## 一、概述

当建立一个vitepress站点后，得到的默认配置文件如下：

```typescript
import { defineConfig } from 'vitepress'

// https://vitepress.dev/reference/site-config
export default defineConfig({
  title: "mist docs",
  description: "vitepress-theme-mist docs",
  themeConfig: {
    // https://vitepress.dev/reference/default-theme-config
    nav: [
      { text: 'Home', link: '/' },
      { text: 'Examples', link: '/markdown-examples' }
    ],

    sidebar: [
      {
        text: 'Examples',
        items: [
          { text: 'Markdown Examples', link: '/markdown-examples' },
          { text: 'Runtime API Examples', link: '/api-examples' }
        ]
      }
    ],

    socialLinks: [
      { icon: 'github', link: 'https://github.com/vuejs/vitepress' }
    ]
  }
})
```

而在主题开发中，往往需要提供一些配置来丰富主题的功能，最简单的是和 VitePress 的 themeConfig 配置合在一起：

```typescript
// .vitepress/config.mts
import { defineConfig } from "vitepress";

export default defineConfig({
  // ...
  themeConfig: {
    // vitepress 配置
    // 自定义主题配置
  },
});
```

然后在组件里通过 `useData` 获取 `themeConfig` 的内容：

```vue
<script setup lang="ts">
import { useData } from "vitepress";

// 获取 themeConfig
const { theme } = useData;

// 获取自定义主题配置项
const xx = theme.value.xxx;
</script>

<template></template>
```

当主题需要添加一个 `head` 或者 `vite` 插件，需要让用户修改 VitePress 的配置，这样极其不方便。因此可以先将主题配置抽离出来，然后使用 `extends` 来合并主题配置。

## 二、extends 合并配置

VitePress 提供了 `extends` 来合并外界传来的配置项，比如外界的配置提供了部分 `head` 内容，并且在 VitePress 也配置了 `head`，则最终合并为一个全新的 head，而不是覆盖。

### 1. extends

> Tips：VitePress 的配置项只有为对象/数组时可以合并，如果配置项为一个固定的值或者函数，则以 VitePress 的配置项为主。

`extends` 合并主题配置的使用方式如下：

```typescript
import { defineConfig } from "vitepress";

// 主题配置
const MistConfig = {};

// vitepress 配置
export default defineConfig({
  extends: MistConfig,
  // ...
  themeConfig: {
    // ...
  },
});
```

在 VitePress 配置中通过 `extends` 可以将主题配置合并到 VitePress 配置里，也就是说完全可以在主题配置里添加 VitePress 的配置项，但是不能反过来。

### 2. 配置合并示例

#### 2.1 分别配置

```typescript
// .vitepress/config.mts
import { defineConfig } from "vitepress";

// 主题配置
const myThemeConfig = { themeConfig: { MistTheme: true } };

// VitePress 配置
export default defineConfig({
  extends: myThemeConfig,
  base: "/",
});
```

#### 2.2 统一配置

```typescript
// .vitepress/config.mts
import { defineConfig } from "vitepress";

// 主题配置 + VitePress 配置
const myThemeConfig = { base: "/", themeConfig: { MistTheme: true } };

export default defineConfig({
  extends: myThemeConfig,
});
```

## 三、函数式构建配置

在主题配置里，如果要使用 Vite 插件或者想要修改 VitePress 默认的配置，则可以提供一个函数来返回主题配置：

```typescript
// .vitepress/myThemeConfig.ts
import type { DefaultTheme, UserConfig } from "vitepress";
// import type { PluginOption } from "vite";

interface ThemeConfig {
  useTheme?: boolean; // 是否开启主题
  // ...
}

export default function getThemeConfig(config: ThemeConfig & UserConfig<DefaultTheme.Config> = {}): UserConfig {
  // 获取用户的配置，进行逻辑处理
  const { useTheme = true, ...themeConfig } = config;

  if (!useTheme) return {};

  return {
    // ignoreDeadLinks 默认值修改为 true，当用户在 VitePress 手动改为 false 才为 false
    ignoreDeadLinks: true,
    // 添加主题需要的 head 信息
    head: [],
    vite: {
      // 添加主题需要的 Vite 插件
      plugins: [],
    },
    themeConfig,
  };
}
```

在 `.vitepress/config.mts` 引入该函数：

```typescript
import { defineConfig } from "vitepress";
import getThemeConfig from "./myThemeConfig";

const myThemeConfig = getThemeConfig({ useTheme: true });

// VitePress 配置
export default defineConfig({
  extends: myThemeConfig,
  // ...
});
```

## 四、开发实例

### 1. 源码

[docs-site/vitepress-theme-mist at 3e5d81e9b7dff0c94a46f993bd8fe8355c2c4a25](https://github.com/docs-site/vitepress-theme-mist/tree/3e5d81e9b7dff0c94a46f993bd8fe8355c2c4a25)

### 2. 工作区外示例

首先安装`vitepress-theme-mist`：

```bash
npm i -D ..\vitepress-theme-mist\dist\vitepress-theme-mist\
npm i vitepress-theme-mist
```

然后在`.vitepress/config.mts`中添加以下内容：

```typescript
import { defineMistConfig } from "vitepress-theme-mist/config"; 

const myThemeConfig = defineMistConfig({ 
    useTheme: true,
    themeConfig: {
      logo: '/favicon.svg', // 导航栏标题的logo
      footer: {
        message: '前路漫漫亦灿灿',
        copyright: 'Copyright © 2019-present 苏木'
      }
    }
  }
);

// https://vitepress.dev/reference/site-config
export default defineConfig({
  extends: myThemeConfig,
  //......
}
```

### 3. 工作区内示例

#### 3.1 基本用法

然后就是工作区内的vitepress站点怎么使用？我们在`.vitepress/config.mts`中添加：

```bash
import { defineMistConfig } from "../../../packages/config";
```

然后就和上面一样：

```typescript
import { defineMistConfig } from "vitepress-theme-mist/config"; 

const myThemeConfig = defineMistConfig({ 
    useTheme: true,
    themeConfig: {
      logo: '/favicon.svg', // 导航栏标题的logo
      footer: {
        message: '前路漫漫亦灿灿',
        copyright: 'Copyright © 2019-present 苏木'
      }
    }
  }
);

// https://vitepress.dev/reference/site-config
export default defineConfig({
  extends: myThemeConfig,
  //......
})
```

#### 3.2 一个问题

##### 3.2.1 现象

上面要写三级的相对路径，但是想一下，我们前面不是在tsconfig.base.json映射过了:

```json
{
  //......
  "paths": {                            // 路径映射，用于模块解析的别名配置
    "@mist/*": ["packages/*"]           // 将 @mist/* 映射到 packages/* 目录
  }
}
```

直接用这个@mist不就可以了，当我们尝试使用包导入的方式：
```typescript
import { defineMistConfig } from "@mist/config";
```

会出现以下错误：

```bash
failed to load config from D:\sumu_blog\vitepress-theme-mist\docs\src\.vitepress\config.mts
failed to start server. error:
Unknown file extension ".ts" for D:\sumu_blog\vitepress-theme-mist\packages\config\index.ts
TypeError [ERR_UNKNOWN_FILE_EXTENSION]: Unknown file extension ".ts" for D:\sumu_blog\vitepress-theme-mist\packages\config\index.ts
    at Object.getFileProtocolModuleFormat [as file:] (node:internal/modules/esm/get_format:219:9)
    at defaultGetFormat (node:internal/modules/esm/get_format:245:36)
    at defaultLoad (node:internal/modules/esm/load:120:22)
    at async ModuleLoader.loadAndTranslate (node:internal/modules/esm/loader:580:32) 
```

##### 3.2.2 原因分析

这个问题的根本原因是 Node.js 无法直接执行 TypeScript 文件：

（1）**相对路径导入能正常工作的原因**：

使用 `import { defineMistConfig } from "../../../packages/config"` 时，VitePress 开发服务器使用 Vite 的构建系统处理这些导入，Vite 通过 esbuild 即时编译 TypeScript 文件，所以可以正常工作。

（2）**包导入失败的原因**：

使用 `import { defineMistConfig } from "@mist/config"` 时，Node.js 通过模块解析机制查找包，并查看`packages/config/package.json` 的 `main` 字段，当前 `main` 字段指向 `index.ts`，而 Node.js 无法直接执行 TypeScript 文件，因此抛出 "Unknown file extension" 错误。

##### 3.2.3 解决方案

要解决这个问题，我们需要为 `@mist/config` 包提供编译后的 JavaScript 文件：

（1）修改 `packages/config/package.json`，添加构建配置和正确的入口点

（2）添加 TypeScript 构建脚本

（3）构建后，`main` 字段应指向编译后的 JavaScript 文件而非源文件
